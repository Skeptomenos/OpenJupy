# PRD: OpenCode Jupyter Integration

**Status**: Draft  
**Owner**: Sisyphus  
**Target Date**: January 12, 2026  

---

## 1. Goal
The objective is to provide OpenCode users with a seamless, production-grade Jupyter Notebook integration. This allows for persistent Python execution, real-time data visualization, and notebook-based project management directly through the AI assistant.

## 2. User Stories
- **As a Data Scientist**, I want to execute code in a persistent environment so that I can iteratively build models and explore data.
- **As a Developer**, I want to see visual outputs (plots, tables) generated by the AI so that I can verify data processing steps.
- **As a Power User**, I want the AI to manage my notebooks (inserting/editing cells) while I watch the changes sync in my browser in real-time.

## 3. Technical Strategy
We will utilize **`jupyter-mcp-server`** (by Datalayer) as the core integration engine. Unlike other experimental projects, it supports:
- **Dual Transport**: Stdio for local OpenCode, SSE/HTTP for remote.
- **RTC (Real-Time Collaboration)**: Syncs AI edits directly to the JupyterLab UI.
- **Multimodal**: Handles image/plot outputs.

### 4. Integration Steps

#### 4.1 Dependency Setup
OpenCode environment requires specific package versions for RTC stability:
- `jupyterlab==4.4.1`
- `jupyter-collaboration==4.0.2`
- `datalayer_pycrdt==0.12.17`

#### 4.2 OpenCode Configuration (`opencode.json`)
The integration will be defined as a local MCP server:
```json
"mcp": {
  "jupyter": {
    "type": "local",
    "command": ["uvx", "jupyter-mcp-server@latest"],
    "enabled": true,
    "environment": {
      "JUPYTER_URL": "{env:JUPYTER_URL}",
      "JUPYTER_TOKEN": "{env:JUPYTER_TOKEN}",
      "ALLOW_IMG_OUTPUT": "true"
    }
  }
}
```

#### 4.3 Agent Specialization (`oh-my-opencode.json`)
To avoid context bloat (14+ tools), we will define a specialized **Data-Science** agent that has exclusive access to the `jupyter_*` tools.

```json
"agent": {
  "data-scientist": {
    "name": "Data Scientist",
    "system": "You are a senior data scientist and ML engineer. Use Jupyter tools for all analysis.",
    "tools": {
      "jupyter_*": true,
      "bash": true,
      "read": true
    }
  }
}
```

## 5. Functional Requirements

### R1: Persistence
- The server must maintain a single kernel session across multiple turns within a conversation.
- The state (variables, imports) must be preserved.

### R2: Real-Time Sync
- Edits made by OpenCode must appear in the JupyterLab UI within 2 seconds.
- Requires `jupyter-collaboration` to be active on the host Jupyter server.

### R3: Multimodal Output
- Plots generated (Matplotlib, Plotly, etc.) must be returned as `ImageContent` and rendered by the OpenCode UI.

### R4: "Smart" Error Handling (Enhancement)
- Port the error-to-fix mapping logic from the `ClaudeJupy` discovery.
- Implementation: A wrapper or a middleware in OpenCode that intercepts Jupyter errors and provides "Claude Tips".

## 6. Required Enhancements (The "Fork" logic)
While we can use the library directly, the following "wrapper" logic should be implemented in OpenCode skills:
1. **Auto-Discovery**: A script to find a running Jupyter instance and extract its token automatically.
2. **Kernelspec Fallback**: Logic to ensure a `python3` kernel is used if `claude-jupy` isn't found.
3. **Environment Sync**: Integration with the `uv` tool to ensure kernel dependencies match the project's `pyproject.toml`.

## 9. Roadmap & Enhancements (Backporting from ClaudeJupy)

To achieve "best-in-class" UX, we will backport the following features from the ClaudeJupy project into our OpenCode integration layer:

### 9.1 Claude-Specific Tool Guidance
Modify tool returns to include meta-guidance for the LLM:
- **`claude_tip`**: Explains the result context (e.g., "Namespace contains 'df'").
- **`claude_next`**: Recommends the next logical step (e.g., "Try plotting 'df'").

### 9.2 Intelligent Error Mapping
Implement a middleware that intercepts standard Python tracebacks and appends actionable fix suggestions:
- `ModuleNotFoundError` → "Run `uv add <package>` using the bash tool."
- `cv2` / `sklearn` errors → Mapping to correct package names (`opencv-python`, `scikit-learn`).

### 9.3 Unified `uv` Environment Sync
A tool that detects the project's `pyproject.toml` and automatically ensures the Jupyter kernel's environment matches the project dependencies.

1. **Host Readiness**: Install the standard Jupyter environment on the user's machine.
2. **Configuration (`opencode.json`)**: Add the `jupyter` MCP server.
   ```json
   "mcp": {
     "jupyter": {
       "type": "local",
       "command": ["uvx", "jupyter-mcp-server@latest"],
       "enabled": true,
       "environment": {
         "JUPYTER_URL": "http://localhost:8888",
         "JUPYTER_TOKEN": "{env:JUPYTER_TOKEN}",
         "ALLOW_IMG_OUTPUT": "true"
       }
     }
   }
   ```
3. **Agent Specialization (`oh-my-opencode.json`)**: Create the `data-scientist` agent.
   ```json
   "data-scientist": {
     "model": "google-vertex-anthropic/claude-opus-4-5@20251101",
     "temperature": 0.2,
     "permission": {
       "edit": "allow",
       "bash": "allow"
     },
     "tools": {
       "jupyter_*": true
     }
   }
   ```
4. **Security**: Ensure `JUPYTER_TOKEN` is exported in the user's shell or `.env` file.
5. **Testing**: Run the validation suite (creating notebook, plotting data, restarting kernel).
